package prajwal.in.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import prajwal.in.service.CitizenInfoService;
import prajwal.in.entity.CitizenInfo;
import prajwal.in.repo.PlanRepo;

@Controller
@RequestMapping("/dc")
public class DataCollectionController {

    @Autowired
    private CitizenInfoService infoService;

    @Autowired
    private PlanRepo planRepo;

    // ✅ Case: Coming from "Process" button with pre-filled case number
    @GetMapping("/start/{caseNumber}")
    public String startDataCollectionPrefilled(@PathVariable String caseNumber, Model model) {
        CitizenInfo info = infoService.getByCaseNumber(caseNumber);
        if (info == null) {
            info = new CitizenInfo();
            info.setCaseNumber(caseNumber);
        }
        model.addAttribute("citizenInfo", info);
        model.addAttribute("plans", planRepo.findByActiveSw("Y")); // Only active plans
        return "dc_plan_selection";
    }

    // ✅ Case: Manual entry (open DC module directly, no case number in URL)
    @GetMapping("/start")
    public String startDataCollectionManual(Model model) {
        CitizenInfo info = new CitizenInfo();
        model.addAttribute("citizenInfo", info);
        model.addAttribute("plans", planRepo.findByActiveSw("Y"));
        return "dc_plan_selection";
    }
 // Step 1: Save Plan Selection
    @PostMapping("/plan/save")
    public String savePlanSelection(@ModelAttribute CitizenInfo info) {
        infoService.saveOrUpdate(info);
        return "redirect:/dc/income/" + info.getCaseNumber();
    }

    // Step 2: Show Income Form
    @GetMapping("/income/{caseNumber}")
    public String showIncomeForm(@PathVariable String caseNumber, Model model) {
        CitizenInfo info = infoService.getByCaseNumber(caseNumber);
        if (info == null) {
            info = new CitizenInfo();
            info.setCaseNumber(caseNumber);
        }
        model.addAttribute("citizenInfo", info);
        return "dc_income_details";
    }

    // Step 2: Save Income Form
    @PostMapping("/income/save")
    public String saveIncomeDetails(@ModelAttribute CitizenInfo info) {
        infoService.saveOrUpdate(info);
        return "redirect:/dc/education/" + info.getCaseNumber(); // Step 3
    }

 
}
