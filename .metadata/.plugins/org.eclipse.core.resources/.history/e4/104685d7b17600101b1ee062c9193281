package prajwal.in.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import prajwal.in.dto.BenefitTransactionDTO;
import prajwal.in.entity.BenefitTransaction;
import prajwal.in.entity.CitizenInfo;
import prajwal.in.entity.EligibilityResult;
import prajwal.in.repo.BenefitTransactionRepo;
import prajwal.in.repo.CitizenInfoRepo;
import prajwal.in.repo.EligibilityResultRepo;

import java.time.LocalDate;
import java.util.*;
import java.util.stream.Collectors;

@Service
public class BenefitTransactionServiceImpl implements BenefitTransactionService {

    @Autowired
    private BenefitTransactionRepo transactionRepo;

    @Autowired
    private CitizenInfoRepo citizenInfoRepo;

    @Autowired
    private EligibilityResultRepo eligibilityResultRepo;

    @Override
    public List<BenefitTransactionDTO> getTransactionsByCaseNumber(String caseNumber) {
        List<BenefitTransaction> transactions = transactionRepo.findByCaseNumber(caseNumber);
        return transactions.stream()
                .map(tx -> new BenefitTransactionDTO(
                        tx.getId(),
                        tx.getEdgTraceId(),
                        tx.getCaseNumber(),
                        tx.getPlanName(),
                        tx.getPlanStatus(),
                        tx.getBenefitAmount(),
                        tx.getAccountNumber(),
                        tx.getStartDate(),
                        tx.getEndDate(),
                        tx.getTransactionDate(),
                        tx.getTransactionStatus(),
                        tx.getTotalAmountReceived()
                ))
                .collect(Collectors.toList());
    }

    @Override
    @Transactional
    public void sendMoneyToAllApproved() {
        // Fetch only "Approved" plans from repo
        List<EligibilityResult> approvedPlans = eligibilityResultRepo.findByPlanStatus("Approved");

        if (approvedPlans.isEmpty()) {
            System.out.println("[SendMoney] No approved plans found.");
            return;
        }

        // Group by case number
        Map<String, List<EligibilityResult>> groupedByCase =
                approvedPlans.stream()
                        .filter(er -> er.getCaseNumber() != null)
                        .collect(Collectors.groupingBy(er -> er.getCaseNumber().trim()));

        for (String caseNumber : groupedByCase.keySet()) {
            List<EligibilityResult> plans = groupedByCase.get(caseNumber);

            // Look up citizen for account number
            Optional<CitizenInfo> optInfo = citizenInfoRepo.findAllByCaseNumber(caseNumber)
                    .stream().findFirst();

            if (optInfo.isEmpty() || optInfo.get().getAccountNumber() == null ||
                optInfo.get().getAccountNumber().isBlank()) {
                System.out.printf("[SendMoney] Skipping case %s: no account number.%n", caseNumber);
                continue;
            }
            String accountNumber = optInfo.get().getAccountNumber();

            // Sum all benefits for that case
            double totalBenefit = transactionRepo.findByCaseNumber(caseNumber).stream()
                    .mapToDouble(tx -> tx.getBenefitAmount() != null ? tx.getBenefitAmount() : 0.0)
                    .sum();

            for (EligibilityResult plan : plans) {
                boolean alreadyPaid = transactionRepo.findByCaseNumber(caseNumber).stream()
                        .anyMatch(tx -> tx.getPlanName().equalsIgnoreCase(plan.getPlanName()) &&
                                        tx.getPlanStatus().equalsIgnoreCase("Approved"));

                if (alreadyPaid) {
                    System.out.printf("[SendMoney] Skipping duplicate for case %s, plan %s%n",
                            caseNumber, plan.getPlanName());
                    continue;
                }

                double planAmount = plan.getBenefitAmount() != null ? plan.getBenefitAmount() : 0.0;

                BenefitTransaction tx = new BenefitTransaction();
                tx.setCaseNumber(caseNumber);
                tx.setPlanName(plan.getPlanName());
                tx.setPlanStatus(plan.getPlanStatus());
                tx.setBenefitAmount(planAmount);
                tx.setAccountNumber(accountNumber);
                tx.setStartDate(plan.getStartDate());
                tx.setEndDate(plan.getEndDate());
                tx.setTransactionDate(LocalDate.now());
                tx.setTransactionStatus("Success");
                tx.setEdgTraceId(UUID.randomUUID().toString());
                tx.setTotalAmountReceived(totalBenefit + planAmount);

                transactionRepo.save(tx);

                System.out.printf("[SendMoney] Paid case %s, plan %s, amount %.2f%n",
                        caseNumber, plan.getPlanName(), planAmount);
            }
        }
    }
}
